<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasy Character Generator – RPG & Writing Characters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Generate a complete fantasy character with name, calling, archetype, virtue, flaw, wound, goal, bond, tell, and signature gear. Includes per-field rerolls.">
  <link rel="stylesheet" href="/css/styles.css">
  <!-- AdSense base script -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2329818065573493"
       crossorigin="anonymous"></script>
</head>
<body>

  <!-- Header / Nav -->
  <div id="cc-header"></div>

  <!-- Main -->
  <main class="cc-main">
    <section class="cc-section">

      <!-- Page header row with button -->
      <div class="cc-generator-header">
        <div class="cc-generator-main">
          <div class="cc-generator-icon">
            <svg
              class="cc-generator-icon-svg"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M18 11c-1.5 0-2.5.5-3 2"/>
              <path d="M4 6a2 2 0 0 0-2 2v4a5 5 0 0 0 5 5 8 8 0 0 1 5 2 8 8 0 0 1 5-2 5 5 0 0 0 5-5V8a2 2 0 0 0-2-2h-3a8 8 0 0 0-5 2 8 8 0 0 0-5-2z"/>
              <path d="M6 11c1.5 0 2.5.5 3 2"/>
            </svg>
          </div>

          <div>
            <h2 class="cc-page-title">Fantasy Character Generator</h2>
            <p class="cc-page-subtitle">
              Generate one complete character at a time — archetype, calling, virtues, flaws, bonds, and gear.
              Use lock to keep fields. Edit with the pencil. Reroll replaces.
            </p>
          </div>
        </div>

        <div class="cc-generator-actions">
          <button id="cc-generate" class="cc-button-primary" type="button">
            Generate Character
          </button>
        </div>
      </div>

      <hr class="cc-section-divider">

      <p class="cc-page-seo">
        This fantasy character generator creates complete characters for tabletop RPGs, worldbuilding, and fiction writing.
        Each character includes a name, archetype, calling, core traits, a defining wound, a clear goal, and signature gear.
        Lock what you want to keep, reroll the rest, then copy.
      </p>

      <p class="cc-related">
        Related tools:
        <a href="/random/npc.html">NPCs</a>,
        <a href="/random/quest-hook.html">Quest Hooks</a>,
        <a href="/random/place-names.html">Place Names</a>
      </p>

      <!-- Results panel -->
      <div id="cc-panel" class="cc-generator-panel">

        <div id="cc-empty" class="cc-empty-state">
          Click <strong>Generate Character</strong> to create one fantasy character.
        </div>

        <div id="cc-results" hidden>

          <div class="cc-sheet-header">
            <div>
              <h3 class="cc-sheet-title">Character Sheet</h3>
              <p class="cc-sheet-subtitle">Lock fields to keep them, then reroll the rest. Pencil edits are kept.</p>
            </div>

            <div class="cc-sheet-actions">
              <button
                id="cc-sheet-copy"
                class="cc-sheet-reroll"
                type="button"
                aria-label="Copy Character"
                title="Copy Character"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                  <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="cc-sheet-grid" id="cc-sheet-grid"></div>

        </div>

      </div>

    </section>
  </main>

  <!-- AdSense slot -->
  <section class="cc-adsense">
    <div class="cc-adsense-slot">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-2329818065573493"
           data-ad-slot="9373337765"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </section>

  <!-- Footer -->
  <div id="cc-footer"></div>

  <!-- JS -->
  <script>
    (function () {
      const btnTop = document.getElementById('cc-generate');
      const empty = document.getElementById('cc-empty');
      const resultsWrap = document.getElementById('cc-results');
      const grid = document.getElementById('cc-sheet-grid');
      const copyBtn = document.getElementById('cc-sheet-copy');

      const FIELDS = [
        { key: 'name', label: 'Name' },
        { key: 'calling', label: 'Calling' },
        { key: 'archetype', label: 'Archetype' },
        { key: 'virtue', label: 'Virtue' },
        { key: 'flaw', label: 'Flaw' },
        { key: 'wound', label: 'Wound' },
        { key: 'goal', label: 'Goal' },
        { key: 'bond', label: 'Bond' },
        { key: 'tell', label: 'Tell' },
        { key: 'signature_gear', label: 'Signature Gear' },
      ];

      const rerollIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="m17 2 4 4-4 4"/>
          <path d="M3 11v-1a4 4 0 0 1 4-4h14"/>
          <path d="m7 22-4-4 4-4"/>
          <path d="M21 13v1a4 4 0 0 1-4 4H3"/>
        </svg>
      `;

      const editIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
          <path d="m15 5 4 4"/>
        </svg>
      `;

      const lockIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="16" r="1"/>
          <rect x="3" y="10" width="18" height="12" rx="2"/>
          <path d="M7 10V7a5 5 0 0 1 10 0v3"/>
        </svg>
      `;

      // stores locked fields (front-end only)
      const locked = new Set();

      function parseBlock(text) {
        const out = {};
        text.split('\n').forEach((raw) => {
          const line = raw.trim();
          if (!line) return;
          const idx = line.indexOf(':');
          if (idx === -1) return;
          out[line.slice(0, idx).toLowerCase()] = line.slice(idx + 1).trim();
        });
        return out;
      }

      async function fetchCharacter() {
        const res = await fetch('/api/character', { headers: { 'Accept': 'text/plain' } });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return parseBlock(await res.text());
      }

      function startEdit(valEl, key) {
        if (!valEl || valEl.dataset.editing === '1') return;

        const original = valEl.textContent.trim();
        const isLong =
          key === 'wound' ||
          key === 'goal' ||
          key === 'bond' ||
          key === 'tell' ||
          original.length > 60;

        valEl.dataset.editing = '1';

        const input = document.createElement(isLong ? 'textarea' : 'input');
        input.className = 'cc-inline-input';
        input.value = (original === '—') ? '' : original;
        if (isLong) input.rows = 3;

        valEl.textContent = '';
        valEl.appendChild(input);
        input.focus();
        input.select?.();

        const commit = () => {
          valEl.textContent = input.value.trim() || '—';
          delete valEl.dataset.editing;
        };

        input.addEventListener('blur', commit);
        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' && !isLong) {
            ev.preventDefault();
            commit();
          }
          if (ev.key === 'Escape') {
            valEl.textContent = original || '—';
            delete valEl.dataset.editing;
          }
        });
      }

      function setLockUI(row, key, isLocked) {
        const lockBtn = row.querySelector('.cc-sheet-lock-btn');
        if (!lockBtn) return;

        lockBtn.dataset.locked = isLocked ? '1' : '0';
        lockBtn.setAttribute('aria-pressed', isLocked ? 'true' : 'false');
        lockBtn.title = isLocked ? `Unlock ${row.querySelector('.cc-sheet-label')?.textContent || key}` : `Lock ${row.querySelector('.cc-sheet-label')?.textContent || key}`;

        // ADD THIS LINE:
        row.classList.toggle('cc-locked', isLocked);

        // subtle visual hint without needing new CSS
        lockBtn.style.opacity = isLocked ? '1' : '0.75';
        lockBtn.style.transform = isLocked ? 'scale(1.02)' : 'none';
      }

      function toggleLocked(row, key) {
        if (locked.has(key)) {
          locked.delete(key);
          setLockUI(row, key, false);
        } else {
          locked.add(key);
          setLockUI(row, key, true);
        }
      }

      function ensureRows() {
        if (grid.children.length) return;

        FIELDS.forEach(({ key, label }) => {
          const row = document.createElement('div');
          row.className = 'cc-sheet-row';
          row.dataset.key = key;

          row.innerHTML = `
            <div class="cc-sheet-label">${label}</div>
            <div class="cc-sheet-value" title="Click to edit">—</div>

            <!-- keep actions in ONE cell -->
            <div class="cc-sheet-actions" style="display:flex; justify-content:flex-end; gap:8px;">
              <button class="cc-sheet-reroll cc-sheet-lock-btn" type="button"
                aria-label="Lock ${label}" aria-pressed="false" title="Lock ${label}">
                ${lockIcon}
              </button>

              <button class="cc-sheet-reroll cc-sheet-edit-btn" type="button"
                aria-label="Edit ${label}" title="Edit ${label}">
                ${editIcon}
              </button>

              <button class="cc-sheet-reroll cc-sheet-reroll-btn" type="button"
                aria-label="Reroll ${label}" title="Reroll ${label}">
                ${rerollIcon}
              </button>
            </div>
          `;

          const val = row.querySelector('.cc-sheet-value');
          const lockBtn = row.querySelector('.cc-sheet-lock-btn');
          const editBtn = row.querySelector('.cc-sheet-edit-btn');
          const rerollBtn = row.querySelector('.cc-sheet-reroll-btn');

          // click-to-edit
          val.addEventListener('click', () => startEdit(val, key));

          // lock toggle
          lockBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleLocked(row, key);
          });

          // pencil edit
          editBtn.addEventListener('click', (e) => {
            e.preventDefault();
            startEdit(val, key);
          });

          // reroll (blocked if locked)
          rerollBtn.addEventListener('click', async () => {
            if (locked.has(key)) return;
            const fresh = await fetchCharacter();
            if (fresh[key]) val.textContent = fresh[key];
          });

          // initial ui
          setLockUI(row, key, false);

          grid.appendChild(row);
        });
      }

      function applyCharacter(ch, { respectLocks } = { respectLocks: false }) {
        ensureRows();
        FIELDS.forEach(({ key }) => {
          if (respectLocks && locked.has(key)) return;
          const val = grid.querySelector(`[data-key="${key}"] .cc-sheet-value`);
          if (val) val.textContent = ch[key] || '—';
        });
      }

      function buildSheetText() {
        return Array.from(grid.querySelectorAll('.cc-sheet-row'))
          .map(row => {
            const label = row.querySelector('.cc-sheet-label')?.textContent;
            const value = row.querySelector('.cc-sheet-value')?.textContent;
            return value && value !== '—' ? `${label}: ${value}` : null;
          })
          .filter(Boolean)
          .join('\n');
      }

      // Store original icon
      const copyIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
        </svg>
      `;

      const checkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      `;

      copyBtn.addEventListener('click', async () => {
        const text = buildSheetText();
        if (text) {
          await navigator.clipboard.writeText(text);
          
          // Swap to checkmark
          copyBtn.innerHTML = checkIcon;
          setTimeout(() => {
            copyBtn.innerHTML = copyIcon;
          }, 1500);
        }
      });

      let busy = false;
      btnTop.addEventListener('click', async () => {
        if (busy) return;
        busy = true;

        btnTop.textContent = 'Generating…';
        try {
          const ch = await fetchCharacter();

          // FIRST generate: fill everything
          // NEXT generates: keep locked fields, reroll the rest
          const hasRows = grid.children.length > 0;
          applyCharacter(ch, { respectLocks: hasRows });

          empty.style.display = 'none';
          resultsWrap.hidden = false;
          btnTop.textContent = 'Generate Another';
        } catch (e) {
          console.error(e);
          btnTop.textContent = 'Error – Try Again';
        } finally {
          busy = false;
        }
      });
    })();
  </script>

  <script>
    fetch('/partials/header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('cc-header').innerHTML = html;
      });

    fetch('/partials/footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('cc-footer').innerHTML = html;
      });
  </script>

</body>
</html>
